---
title: "Habitat representativeness index"
author: "Isabelle Lebeuf-Taylor, Vanessa Di Maurizio, Vincent Bellavance et Benjamin Mercier"
documentclass: book
output:
  html_document:
    toc: true
    number_sections: true
  revealjs_presentation:
    incremental: true   
---


```{r canada_map eval=FALSE, echo=FALSE}
library(sf)
library(ggplot2)

# CANADA
# Check available layers for portected areas and ecozones
sf::st_layers("0_Data/AireProtegeeConservee_2023/AireProtegeeConservee_2023.gdb")
sf::st_layers("0_Data/Ecozones/ecozones.shp")

# Read the layers and normalize crs with the protected areas map
protected_area <- sf::st_read("0_Data/AireProtegeeConservee_2023/AireProtegeeConservee_2023.gdb", layer = "AireProtegeeConservee_2023")
ecozones <- sf::st_read("0_Data/Ecozones/ecozones.shp", layer = "ecozones") |>
  sf::st_transform(crs = sf::st_crs(protected_area))

# Set custom colors for the ecozones
custom_colors <- c("Northern Arctic" = "lightskyblue", "Arctic Cordillera" = "royalblue", "Southern Arctic" = "royalblue4", "Taiga Cordillera" = "lavenderblush3", "Taiga Plain" = "khaki4", "Taiga Shield" = "orangered4", "Boreal Cordillera" = "darkolivegreen", "Boreal PLain" = "darkgreen", "Pacific Maritime" = "turquoise3", "Boreal Shield" = "coral2", "Hudson Plain" = "lightsalmon3", "Montane Cordillera" = "gold3", "Prairie" = "orange", "Atlantic Maritime" = "midnightblue", "MixedWood Plain" = "springgreen")

# Plot
map <- ggplot() +
  geom_sf(data = ecozones, aes(fill = as.factor(ZONE_NAME)), alpha = 0.5) +
  scale_fill_manual(values = custom_colors) +
  geom_sf(data = protected_area, aes(fill = as.factor(IUCN_CAT)), alpha = 0.2) +
  theme_minimal()+
  theme(
       legend.position = "bottom",
       legend.text = element_text(size = 8),
       legend.title = element_text(size = 10),
       plot.title = element_text(size = 15)
      ) +
  labs(fill = "Ecozones")

ggsave("figures/map.png", plot = map, dpi = "retina", height = 18, width = 18, units = "cm", bg = "white")


# QUEBEC
# Check available layers for portected areas and ecozones
sf::st_layers("0_Data/CLASSI_ECO_QC_GDB/CLASSI_ECO_QC.gdb")

# Read the layers and normalize crs with the protected areas map
qc_bioclimatic <- sf::st_read("0_Data/CLASSI_ECO_QC_GDB/CLASSI_ECO_QC.gdb", layer = "N3_DOM_BIO") |>
  sf::st_transform(crs = sf::st_crs(protected_area))

# Get the map of Quebec
quebec_map <- rnaturalearth::ne_states(country = "canada", returnclass = "sf") |>
  dplyr::filter(name_en == "Quebec") |>
  sf::st_transform(st_crs(protected_area))

protected_area <- sf::st_cast(protected_area, "MULTIPOLYGON")
quebec_protected_area <- st_intersection(protected_area, quebec_map)

custom_colors_qc <- c("Érablière à caryer cordiforme" = "lightpink1", "Érablière à tilleul" = "tan2", "Érablière à bouleau jaune" = "tomato3", "Sapinière à bouleau jaune" = "yellow3", "Sapinière à bouleau à papier" = "khaki3", "Pessière à mousses" = "springgreen4","Pessière à lichens" = "darkolivegreen", "Toundra forestière" = "cadetblue1", "Toundra à arbustes dressés" = "slategray", "Toundra à arbustes prostrés" = "snow3")

map_quebec <- ggplot() +
  geom_sf(data = quebec_map, fill = "white", color = "black") +
  geom_sf(data = qc_bioclimatic, aes(fill = as.factor(NOM_DB)), alpha = 0.5) +
  scale_fill_manual(values = custom_colors_qc) +
  geom_sf(data = quebec_protected_area, aes(fill = as.factor(IUCN_CAT)), alpha = 0.2) +
  theme_minimal()+
  theme(
       legend.position = "bottom",
       legend.text = element_text(size = 6),
       legend.title = element_text(size = 7)
      ) +
  labs(fill = "Bioclimatic domains")

ggsave("figures/quebec_map.png", plot = map_quebec, dpi = "retina", height = 18, width = 21, units = "cm", bg = "white")
```



### Workflow

Headline indicator: Protected Habitat Coverage (PHC)
Complementary indicator: Protected Habitat Eveness / Protection d'Habitat égal (PHE)

```{r echo=FALSE}
library(DiagrammeR)

DiagrammeR(
  "
  graph TB
  
  A[Data ecoregion] --> C[Joined data]
  B[Data protected areas] --> C[Joined data]
  C --> E[Compute PHC by ecoregions and type and ecoregions]
  C --> F[Compute PHE across ecoregions and types ecoregions]
  E --> G[Visualize MAP]
  F --> H[Visualize Score 3 bins: low-intermediary-high]
  "
)
```



![](figures/map.png)